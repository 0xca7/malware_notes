# Colibri Loader

Sample (SHA256): `1b2eaff481b083525a42635e86bbeb6ca0e7c1c9c3d880ba29754b9a2277b962`

URL: https://bazaar.abuse.ch/sample/1b2eaff481b083525a42635e86bbeb6ca0e7c1c9c3d880ba29754b9a2277b962/

---

## Notes

loads **libraries**:
- advapi
- wininet
- shell32
- user32
- shlwapi

library names are jumbled around stack strings:
![ef1d1f473d4ae36d172e602e07589052.png](../_resources/ef1d1f473d4ae36d172e602e07589052.png)

these are assembled and `LoadLibraryW` is called to get a handle to the target library. Function addresses are then obtained as needed. These are also obfuscated/encrypted.


**Deobfuscates Strings** via this function:

![94c904eb8ad4435f4ea7faf76c302717.png](../_resources/94c904eb8ad4435f4ea7faf76c302717.png)

For example function names as mentioned above and mutex name (see below).
This is the IP which is decoded: `188[.]130[.]139[.]47`

In memory:
![7ac5e770a77b7ff97bd3f593ef3e066e.png](../_resources/7ac5e770a77b7ff97bd3f593ef3e066e.png)

Register:
![8b614f30c89d45c9df97cf3651e40a5c.png](../_resources/8b614f30c89d45c9df97cf3651e40a5c.png)


Later, decodes a mutex name and calls CreateMutexW and GetLastError with check for 0xb7 -> checks if malware is already running.

Mutex Name `6rmUi1hRdfbvOQyXqa0T`:
![3f17375657f263f96166a25a88cb6099.png](../_resources/3f17375657f263f96166a25a88cb6099.png)

Procmon:
![34b59b91b6c22df0f03f58e477c73285.png](../_resources/34b59b91b6c22df0f03f58e477c73285.png)

Reaches 0x4045c2 which seems to be the main routine that establishes a connection to C2 server. 

routine 0x004046c0 decodes `/gate.php` and this:

![92493aac4e82c9f4f1011a56676fb3f8.png](../_resources/92493aac4e82c9f4f1011a56676fb3f8.png)

![a8653f98733e3d5a36739b8a69b3c813.png](../../_resources/a8653f98733e3d5a36739b8a69b3c813.png)

![f7002285bb626ca264d262c31466277d.png](../_resources/f7002285bb626ca264d262c31466277d.png)

![8470516c58853ac0c485421627e63bca.png](../_resources/8470516c58853ac0c485421627e63bca.png)

![1ec22131464722e52cc4590e3e610ee6.png](../_resources/1ec22131464722e52cc4590e3e610ee6.png)

![8bd9bbce235e1b84411c28a0451e44e2.png](../../_resources/8bd9bbce235e1b84411c28a0451e44e2.png)
![06bf6c96e4c67e4758b247dc218ffce6.png](../_resources/06bf6c96e4c67e4758b247dc218ffce6.png)

Full Request:
![6077d75afc7439f9d961eca224372344.png](../_resources/6077d75afc7439f9d961eca224372344.png)

decodes everything needed for GET request.


0x4040ce makes the HTTP request via:

1. InternetOpenW
2. InternetConnectW
3. HttpOpenRequestW
4. HttpSendRequestW

Using a netcat listener to catch the connection:

![976bc8182fd62f0bb6d27624f4e67e37.png](../_resources/976bc8182fd62f0bb6d27624f4e67e37.png)

--- 

### IOCs

```console
IP: 188[.]130[.]139[.]47
Path: /gate.php/type=check&uid=
UID: 0F94C1C01E803234201734
Mutex: 6rmUi1hRdfbvOQyXqa0T
```



